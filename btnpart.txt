Better-Than-Nothing partitioner for NEC PC-9801/9821
version 0.0.4
document in Japanese (Shift_JIS)

説明:
-----

PC-9801/9821 用の簡易版ハードディスク初期化ツールです。
その名の通り、「ないよりまし」(better than nothing) 程度の
出来栄えとなっています。

・複数領域の作成はできない
  （ハードディスクのほぼ全容量がひとつの領域として確保されます）
・起動メニューはない
・作った領域は MS-DOS 3.3 では読めない
　（DOS 5 以上必須となります。また領域容量の大小にかかわらず、
  ファイルシステムは FAT16 となります）
・システムは転送されない
　（FreeDOS カーネルに同梱されている sys コマンドを使ってください）

なお、今のところ、実機での動作はまったく未確認です。


用法:
-----

btnpart.exe, btnpart.mbr, fat16hd.pbr を同じディレクトリに置いて、
DOS のコマンドライン上から btnpart を実行し、画面の指示に従ってください。
また、同じディレクトリに FreeBSD.MBR が存在する場合、btnpart.mbr の
代わりに起動用 IPL（＋起動メニュー）として使うかを選ぶことができます。

btnpart の有効なコマンドラインオプションは以下のようになっています。

  --format              ハードディスク全体のフォーマットを行うかどうかを
                        ユーザーに確認し、許可された場合はフォーマットを
                        行います（セクタサイズやインターリーブは BIOS の
                        デフォルト値をそのまま使います）。
                        ディスク全体に書き込みを行うため、処理に非常に
                        時間がかかる場合があります。
                        
                        エミュレータ上で SCSI ディスクイメージ上に領域を
                        確保する場合、ディスク全体のフォーマットを行う
                        必要があります。
                        実機の IDE ハードディスクやエミュレータの SASI
                        ディスクイメージに対しては基本的に必要ありません。

  --erase-track0        IPL 書き換え時にトラック 0 の内容を消去します。
                        以前に PC-98やエプソン機用のMS-DOS/Windows で
                        ディスクの初期化や領域確保を行っている場合、
                        この部分に起動メニューがインストールされています。
                        ハードディスクイメージを再配布するときなどのような、
                        起動メニューの実行コードをディスクから完全に
                        消去したい場合はこのオプションを指定してください。

  --necfatid            FAT ID（FAT領域の先頭バイト）の値を NEC版MS-DOSに
                        準拠した値(0xFE)に設定します。
                        
                        このオプションを設定しない場合、FAT IDの値が標準的な
                        IBM PC版MS-DOSに準拠した値(0xF8)になるほか、IPLの
                        先頭4バイトが「EB ?? 90 90」のときは後半2バイトが
                        クリアされ「EB ?? 00 00」になります。
                        
                        なお、このオプションを設定しない場合、NEC版MS-DOS 6.2
                        付属のSCANDISKでチェックすると「問題が見つかりました」
                        と表示され、FATメディアバイト(FAT ID)を修復するか
                        どうか選ぶ必要が出てきますが、修復しなくても実用上は
                        問題ありません（エプソン版MS-DOS 6.2やWindows付属の
                        SCANDISKではこの問題は発生しません）。
                        
                        IBM PC互換のMBRとディスク領域を設定していないと正しく
                        メディアを認識しない一部のSD-IDE変換アダプタ等を
                        使用する場合は、このオプションを指定しないほうが
                        より安全だと思われます。


ソースコード:
-------------

ソースのビルドには以下のものが必要です。

・LSI-C86 3.30c 試食版 / OpenWatcom C++
・nasm
・upx（なくてもよい）

btnpart 本体はいわゆる ZLIB ライセンス、ブートローダ部はいわゆる
パブリックドメイン扱いで再利用可能です。
本ソフトウェアは完全に無保証です。


履歴:
-----

2015-09-05  0.0.0
    * 作成
2015-09-08  0.0.1
    * --format オプション
    * --format-track0 を --erase-track0 に変更
2018-04-18  0.0.2
    * 2Gバイト以上のディスクで正しい領域が作成できない不具合の修正
2020-03-06  0.0.3
    * FreeBSD.MBR（FreeBSD(98)ブートセレクタ）を選択可能に
    * 非PC-98機向けのIPL対策(btnpart.mbr)
    * IPLセクタ内にIBM PCのMBR互換パーティションテーブルを作成
    * 内部メモリ確保時に64Kバイト境界をまたがない
2020-07-01  0.0.3p1
    * IPL内処理にローカルスタックを使う(btnpart.mbr)
2023-08-25  0.0.4
    * DOS領域内のFAT IDをFEhからF8hに変更
    * IPLの3〜4バイト目が90h 90hの場合、00 00に変更する
    * --necfatid オプション追加。指定された場合は上記2項の変更を行わない
    * IPLの3〜4バイト目を00 00に変更(btnpart.mbr)
    * IPL内にディスクタイムスタンプ、ディスクシグニチャ部を明記(btnpart.mbr)


sava/LP-Project
